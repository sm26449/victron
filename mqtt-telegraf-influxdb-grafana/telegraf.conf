# Telegraf Configuration - Victron Energy Mode
# Collects data from Victron Venus OS via MQTT and stores in InfluxDB v2
#
# Data organization:
#   - Each device type (battery, pvinverter, grid, etc.) becomes a measurement
#   - Tags: portal_id, instance, field (path component)
#   - This allows simple queries like: SELECT * FROM "battery"

[global_tags]
  source = "victron"

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  hostname = ""
  omit_hostname = false

###############################################################################
#                            OUTPUT PLUGINS                                   #
###############################################################################

[[outputs.influxdb_v2]]
  urls = ["${INFLUXDB_URL}"]
  token = "${INFLUXDB_TOKEN}"
  organization = "${INFLUXDB_ORG}"
  bucket = "${INFLUXDB_BUCKET}"

###############################################################################
#                            INPUT PLUGINS                                    #
###############################################################################

# Victron MQTT Input
# Venus OS publishes data to MQTT in JSON format
# Topic structure: N/<portal_id>/<device_type>/<instance>/<path...>

[[inputs.mqtt_consumer]]
  servers = ["${MQTT_SERVER}"]
  insecure_skip_verify = true

  # Topics to subscribe - wildcard patterns for different path depths
  # Replace YOUR_PORTAL_ID with your Victron portal ID (found in VRM or Venus OS)
  topics = [
    "N/${VICTRON_PORTAL_ID}/+/+/+",
    "N/${VICTRON_PORTAL_ID}/+/+/+/+",
    "N/${VICTRON_PORTAL_ID}/+/+/+/+/+",
    "N/${VICTRON_PORTAL_ID}/+/+/+/+/+/+",
  ]

  # QoS policy
  qos = 0

  # Connection settings
  client_id = "telegraf-victron"
  persistent_session = false

  # Authentication (if required by your MQTT broker)
  username = "${MQTT_USERNAME}"
  password = "${MQTT_PASSWORD}"

  # Data format - Victron uses JSON
  # Venus OS publishes: {"value": 123.45} or {"value": "string"}
  data_format = "json"

  # Topic parsing - extract device_type as measurement name
  # This allows simple queries: SELECT * FROM "battery", SELECT * FROM "grid"
  #
  # Topic structure: N/<portal_id>/<device_type>/<instance>/<field1>/<field2>/...
  # We use 'measurement' in the pattern to set the InfluxDB measurement name

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+"
    measurement = "_/_/measurement/_/_"
    tags = "_/portal_id/_/instance/field"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+"
    measurement = "_/_/measurement/_/_/_"
    tags = "_/portal_id/_/instance/field/subfield"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+/+"
    measurement = "_/_/measurement/_/_/_/_"
    tags = "_/portal_id/_/instance/field/subfield/detail"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+/+/+"
    measurement = "_/_/measurement/_/_/_/_/_"
    tags = "_/portal_id/_/instance/field/subfield/detail/extra"
